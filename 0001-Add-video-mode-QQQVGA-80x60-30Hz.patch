From fe6c4c82fbfa2196746ef7eedea3666ba4f734e8 Mon Sep 17 00:00:00 2001
From: Tim Cheng <timcheng@lips-hci.com>
Date: Tue, 19 Feb 2019 13:40:07 +0800
Subject: [PATCH 1/2] Add video mode QQQVGA 80x60@30Hz

check rgb sensor if device does not support it
---
 openni2_camera/cfg/OpenNI2.cfg        | 9 +++++----
 openni2_camera/src/openni2_driver.cpp | 9 ++++++++-
 2 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/openni2_camera/cfg/OpenNI2.cfg b/openni2_camera/cfg/OpenNI2.cfg
index 6b40fef..98a6988 100755
--- a/openni2_camera/cfg/OpenNI2.cfg
+++ b/openni2_camera/cfg/OpenNI2.cfg
@@ -18,13 +18,14 @@ output_mode_enum = gen.enum([  gen.const(  "SXGA_30Hz", int_t, 1,  "1280x1024@30
                                gen.const(  "QVGA_60Hz", int_t, 9,  "320x240@60Hz"),
                                gen.const( "QQVGA_25Hz", int_t, 10, "160x120@25Hz"),
                                gen.const( "QQVGA_30Hz", int_t, 11, "160x120@30Hz"),
-                               gen.const( "QQVGA_60Hz", int_t, 12, "160x120@60Hz")],
+                               gen.const( "QQVGA_60Hz", int_t, 12, "160x120@60Hz"),
+                               gen.const( "QQQVGA_30Hz", int_t, 13, "80x60@30Hz")],
                                "output mode")
 
 
-gen.add("ir_mode", int_t, 0, "Video mode for IR camera", 5, 1, 12, edit_method = output_mode_enum)
-gen.add("color_mode", int_t, 0, "Video mode for color camera", 5, 1, 12, edit_method = output_mode_enum)
-gen.add("depth_mode", int_t, 0, "Video mode for depth camera", 5, 1, 12, edit_method = output_mode_enum)
+gen.add("ir_mode", int_t, 0, "Video mode for IR camera", 5, 1, 13, edit_method = output_mode_enum)
+gen.add("color_mode", int_t, 0, "Video mode for color camera", 5, 1, 13, edit_method = output_mode_enum)
+gen.add("depth_mode", int_t, 0, "Video mode for depth camera", 5, 1, 13, edit_method = output_mode_enum)
 
 gen.add("depth_registration", bool_t, 0, "Depth data registration", True)
 gen.add("color_depth_synchronization", bool_t, 0, "Synchronization of color and depth camera", False)
diff --git a/openni2_camera/src/openni2_driver.cpp b/openni2_camera/src/openni2_driver.cpp
index 5534f85..afa4e63 100644
--- a/openni2_camera/src/openni2_driver.cpp
+++ b/openni2_camera/src/openni2_driver.cpp
@@ -268,7 +268,8 @@ void OpenNI2Driver::applyConfigToOpenNIDevice()
   data_skip_depth_counter_ = 0;
 
   setIRVideoMode(ir_video_mode_);
-  setColorVideoMode(color_video_mode_);
+  if (device_->hasColorSensor())
+    setColorVideoMode(color_video_mode_);
   setDepthVideoMode(depth_video_mode_);
 
   if (device_->isImageRegistrationModeSupported())
@@ -1078,6 +1079,12 @@ output_mode_enum = gen.enum([  gen.const(  "SXGA_30Hz", int_t, 1,  "1280x1024@30
 
   video_modes_lookup_[12] = video_mode;
 
+  // QQQVGA_30Hz
+  video_mode.x_resolution_ = 80;
+  video_mode.y_resolution_ = 60;
+  video_mode.frame_rate_ = 30;
+
+  video_modes_lookup_[13] = video_mode;
 }
 
 int OpenNI2Driver::lookupVideoModeFromDynConfig(int mode_nr, OpenNI2VideoMode& video_mode)
-- 
2.25.1

